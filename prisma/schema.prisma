// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================= ENUMS =======================
enum ActivityGroup {
  CENTRAL    // กิจกรรมกลาง (Group 1)
  FACULTY    // กิจกรรมคณะ (Group 2)  
  FREE       // กิจกรรมเสรี (Group 3)
}

enum QRType {
  SINGLE_USE    // 1 QR ต่อ 1 คน
  MULTI_USE     // 1 QR ต่อหลายคน (ไม่จำกัด)
  LIMITED_USE   // 1 QR ต่อหลายคน但有จำนวนจำกัด
}

// ======================= MODELS =======================

// ข้อมูลนักศึกษา
model Student {
  id        Int               @id @default(autoincrement())
  stdCode   String            @unique @map("std_code")
  title     String?           // คำนำหน้า (นาย, นาง, นางสาว)
  name      String
  faculty   String?
  program   String?
  
  // ข้อมูลชั่วโมงกิจกรรม
  centralHours  Int           @default(0)  // ชม. กิจกรรมกลาง
  facultyHours  Int           @default(0)  // ชม. กิจกรรมคณะ
  freeHours     Int           @default(0)  // ชม. กิจกรรมเสรี
  
  qrcodes   QRCode[]          // 1 นศ. อาจมีหลาย QR Code
  histories ActivityHistory[] // ประวัติการสแกน

  @@map("tb_student")
}

// ข้อมูลกิจกรรม
model Activity {
  id                Int               @id @default(autoincrement())
  name              String
  description       String?
  startDate         DateTime?
  endDate           DateTime?
  group             ActivityGroup     @default(CENTRAL) // ใช้ enum แทน
  hours             Int               @default(1) // จำนวนชั่วโมงที่ได้รับ
  location          String?           // สถานที่จัดกิจกรรม
  organizer         String?           // ผู้จัดกิจกรรม
  
  qrcodes           QRCode[]          // กิจกรรมนี้มีหลาย QR
  activityHistories ActivityHistory[] // ประวัติการสแกน

  @@map("activities")
}

// QR Code สําหรับใช้สแกนกิจกรรม
model QRCode {
  id          Int               @id @default(autoincrement())
  code        String            @unique
  activityId  Int
  usedBy      Int?              // สำหรับแบบ 1:1 (optional)
  isUsed      Boolean           @default(false)
  usedAt      DateTime?
  
  // ✅ เพิ่มฟิลด์สำหรับจัดการ expiration และประเภท
  expiredAt   DateTime?         // เวลาหมดอายุของ QR
  maxUses     Int               @default(1)    // จำนวนครั้งที่ใช้ได้สูงสุด
  currentUses Int               @default(0)    // จำนวนครั้งที่ใช้ไปแล้ว
  type        QRType            @default(SINGLE_USE) // ประเภท QR
  
  createdAt   DateTime          @default(now())

  // ความสัมพันธ์
  activity    Activity          @relation(fields: [activityId], references: [id], onDelete: Cascade)
  student     Student?          @relation(fields: [usedBy], references: [id], onDelete: SetNull)
  
  // ✅ เปลี่ยนเป็น one-to-many (1 QR มีหลายประวัติ)
  histories   ActivityHistory[] 

  @@map("qr_codes")
}

// ประวัติการสแกนกิจกรรม
model ActivityHistory {
  id          Int       @id @default(autoincrement())
  activityId  Int
  qrCodeId    Int       // ไม่ใช่ unique แล้ว (รองรับ MULTI_USE)
  studentId   Int
  scannedAt   DateTime  @default(now())
  hoursEarned Int       @default(1) // จำนวนชั่วโมงที่ได้จากการสแกนนี้

  // ความสัมพันธ์
  activity    Activity  @relation(fields: [activityId], references: [id], onDelete: Cascade)
  qrCode      QRCode    @relation(fields: [qrCodeId], references: [id])
  student     Student   @relation(fields: [studentId], references: [id])

  @@unique([qrCodeId, studentId]) // ป้องกันการสแกนซ้ำโดยคนเดียวกัน
  @@map("activity_histories")
}

// ✅ ตารางสำหรับเก็บ requirement ของแต่ละคณะ
model FacultyRequirement {
  id          Int      @id @default(autoincrement())
  faculty     String   @unique // ชื่อคณะ
  centralMin  Int      @default(90) // กิจกรรมกลางขั้นต่ำ
  facultyMin  Int      @default(90) // กิจกรรมคณะขั้นต่ำ  
  freeMin     Int      @default(50) // กิจกรรมเสรีขั้นต่ำ

  @@map("faculty_requirements")
}